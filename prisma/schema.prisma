generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String                 @id @default(cuid())
  clerkUserId            String                 @unique
  email                  String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  hasCompletedOnboarding Boolean                @default(false)
  financialGoals         String?
  monthStartDay          Int                    @default(1)
  name                   String?
  preferredCurrency      String                 @default("USD")
  preferredLanguage      String                 @default("en")
  accounts               Account[]
  apiTokens              ApiToken[]
  budgets                Budget[]
  categories             Category[]
  currencyRates          CurrencyRate[]
  imports                Import[]
  notifications          Notification[]
  recurringIncomes       RecurringIncome[]
  recurringTransactions  RecurringTransaction[]
  savingsGoals           SavingsGoal[]
  tags                   Tag[]
  transactions           Transaction[]
  households             HouseholdMember[]
  householdInvitations   HouseholdInvitation[]  @relation("InvitedBy")
  createdHouseholds      Household[]            @relation("CreatedBy")
  creditCards            CreditCard[]
  creditCardTransactions CreditCardTransaction[]

  @@index([clerkUserId])
}

model Account {
  id                    String                 @id @default(cuid())
  userId                String
  name                  String
  type                  String
  balance               Decimal                @default(0) @db.Decimal(12, 2)
  currency              String                 @default("USD")
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringIncomes      RecurringIncome[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]
  linkedCreditCards     CreditCard[]

  @@index([userId])
  @@index([userId, isActive])
}

model Transaction {
  id                      String                @id @default(cuid())
  userId                  String
  accountId               String
  categoryId              String?
  type                    String
  amount                  Decimal               @db.Decimal(12, 2)
  description             String
  date                    DateTime
  notes                   String?
  transferToAccountId     String?
  transferToTransactionId String?
  importId                String?
  externalId              String?
  idempotencyKey          String?               @unique
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  recurringIncomeId       String?
  recurringTransactionId  String?
  savingsGoalId           String?
  householdId             String?
  isShared                Boolean               @default(false)
  account                 Account               @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category                Category?             @relation(fields: [categoryId], references: [id])
  importRecord            Import?               @relation(fields: [importId], references: [id])
  recurringIncome         RecurringIncome?      @relation(fields: [recurringIncomeId], references: [id])
  recurringTransaction    RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id])
  savingsGoal             SavingsGoal?          @relation(fields: [savingsGoalId], references: [id])
  user                    User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  household               Household?            @relation(fields: [householdId], references: [id], onDelete: SetNull)
  tags                    TransactionTag[]

  @@index([userId, date])
  @@index([recurringIncomeId])
  @@index([recurringTransactionId])
  @@index([userId, accountId, date])
  @@index([userId, categoryId])
  @@index([userId, type, date])
  @@index([idempotencyKey])
  @@index([externalId])
  @@index([userId, description])
  @@index([householdId, date])
  @@index([householdId, isShared])
}

model Category {
  id                    String                 @id @default(cuid())
  userId                String?
  name                  String
  type                  String
  color                 String                 @default("#3B82F6")
  icon                  String?
  isDefault             Boolean                @default(false)
  parentId              String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  autoRules             String?
  budgets               Budget[]
  parent                Category?              @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children              Category[]             @relation("CategoryHierarchy")
  user                  User?                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringIncomes      RecurringIncome[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]
  creditCardTransactions CreditCardTransaction[]

  @@index([userId])
  @@index([userId, type])
}

model Budget {
  id         String    @id @default(cuid())
  userId     String
  categoryId String?
  month      Int
  year       Int
  amount     Decimal   @db.Decimal(12, 2)
  householdId String?
  isShared   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  household  Household? @relation(fields: [householdId], references: [id], onDelete: SetNull)

  @@unique([userId, categoryId, month, year])
  @@index([userId, year, month])
  @@index([householdId, year, month])
}

model SavingsGoal {
  id                 String             @id @default(cuid())
  userId             String
  name               String
  targetAmount       Decimal            @db.Decimal(12, 2)
  currentAmount      Decimal            @default(0) @db.Decimal(12, 2)
  targetDate         DateTime?
  isCompleted        Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  contributionMode   String             @default("flexible")
  fixedMonthlyAmount Decimal?           @db.Decimal(12, 2)
  icon               String             @default("üéØ")
  isPaused           Boolean            @default(false)
  priority           String             @default("medium")
  currency           String             @default("USD")
  isRecurring        Boolean            @default(false)
  recurringPeriod    String?
  householdId        String?
  isShared           Boolean            @default(false)
  contributions      GoalContribution[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  household          Household?         @relation(fields: [householdId], references: [id], onDelete: SetNull)
  transactions       Transaction[]
  creditCardTransactions CreditCardTransaction[]

  @@index([userId])
  @@index([userId, isPaused])
  @@index([userId, isCompleted])
  @@index([householdId])
}

model GoalContribution {
  id        String      @id @default(cuid())
  goalId    String
  amount    Decimal     @db.Decimal(12, 2)
  date      DateTime
  note      String?
  createdAt DateTime    @default(now())
  goal      SavingsGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId, date])
}

model Tag {
  id           String           @id @default(cuid())
  userId       String
  name         String
  color        String           @default("#6B7280")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions TransactionTag[]

  @@unique([userId, name])
  @@index([userId])
}

model TransactionTag {
  id            String      @id @default(cuid())
  transactionId String
  tagId         String
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@unique([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
}

model CurrencyRate {
  id           String   @id @default(cuid())
  userId       String
  fromCurrency String
  toCurrency   String
  rate         Decimal  @db.Decimal(12, 6)
  source       String   @default("manual")
  lastUpdated  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fromCurrency, toCurrency])
  @@index([userId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean   @default(false)
  metadata  String?
  createdAt DateTime  @default(now())
  readAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model Import {
  id           String        @id @default(cuid())
  userId       String
  source       String
  status       String
  recordsCount Int           @default(0)
  successCount Int           @default(0)
  errorCount   Int           @default(0)
  errors       String?
  metadata     String?
  createdAt    DateTime      @default(now())
  completedAt  DateTime?
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, createdAt])
  @@index([userId, status])
}

model ApiToken {
  id         String    @id @default(cuid())
  userId     String
  token      String    @unique
  name       String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, isActive])
}

model RecurringIncome {
  id           String        @id @default(cuid())
  userId       String
  accountId    String
  categoryId   String?
  amount       Decimal       @db.Decimal(12, 2)
  description  String
  dayOfMonth   Int
  isActive     Boolean       @default(true)
  nextRunDate  DateTime
  lastRunDate  DateTime?
  householdId  String?
  isShared     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  household    Household?    @relation(fields: [householdId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([nextRunDate])
  @@index([householdId])
  @@index([householdId, isShared])
}

model RecurringTransaction {
  id           String        @id @default(cuid())
  userId       String
  accountId    String
  categoryId   String?
  type         String
  amount       Decimal       @db.Decimal(12, 2)
  description  String
  dayOfMonth   Int
  isActive     Boolean       @default(true)
  nextRunDate  DateTime
  lastRunDate  DateTime?
  endDate      DateTime?
  householdId  String?
  isShared     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  household    Household?    @relation(fields: [householdId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([userId, type])
  @@index([nextRunDate])
  @@index([endDate])
  @@index([householdId])
  @@index([householdId, isShared])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, action])
}

model Household {
  id                String             @id @default(cuid())
  name              String
  icon              String?            @default("üë®‚Äçüë©‚Äçüëß‚Äçüë¶")
  inviteToken       String             @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  createdByUserId   String
  createdBy         User               @relation("CreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  members           HouseholdMember[]
  invitations       HouseholdInvitation[]
  transactions      Transaction[]
  budgets           Budget[]
  savingsGoals      SavingsGoal[]
  creditCards       CreditCard[]
  creditCardTransactions CreditCardTransaction[]
  recurringIncomes  RecurringIncome[]
  recurringTransactions RecurringTransaction[]

  @@index([createdByUserId])
  @@index([inviteToken])
}

model HouseholdMember {
  id          String    @id @default(cuid())
  householdId String
  userId      String
  role        String    @default("member") // "owner", "admin", "member"
  joinedAt    DateTime  @default(now())
  
  // Salary information
  monthlySalary    Decimal?  @db.Decimal(12, 2)
  salaryDay        Int?      // Day of month salary is received (1-31)
  salaryUpdatedAt  DateTime?
  
  household  Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([householdId])
  @@index([userId])
}

model HouseholdInvitation {
  id          String    @id @default(cuid())
  householdId String
  invitedByUserId String
  email       String?
  token       String    @unique
  status      String    @default("pending") // "pending", "accepted", "rejected", "expired"
  expiresAt  DateTime
  acceptedAt DateTime?
  rejectedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  household  Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  invitedBy  User      @relation("InvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([householdId])
  @@index([invitedByUserId])
  @@index([token])
  @@index([email])
  @@index([status])
}

// Credit Card Models
model CreditCard {
  id              String                  @id @default(cuid())
  userId          String
  name            String                  // e.g., "Visa Gold", "Isracard"
  lastFourDigits  String                  // e.g., "1234"
  billingDay      Int                     // Day of month when card is billed (1-28)
  linkedAccountId String                  // Bank account to charge
  creditLimit     Decimal?                @db.Decimal(12, 2)
  isActive        Boolean                 @default(true)
  color           String                  @default("#3B82F6")
  householdId     String?                 // For family cards
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedAccount   Account                 @relation(fields: [linkedAccountId], references: [id], onDelete: Cascade)
  household       Household?              @relation(fields: [householdId], references: [id], onDelete: SetNull)
  transactions    CreditCardTransaction[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([householdId])
  @@index([billingDay])
}

model CreditCardTransaction {
  id            String      @id @default(cuid())
  creditCardId  String
  userId        String
  categoryId    String?
  amount        Decimal     @db.Decimal(12, 2)
  description   String
  date          DateTime    // Date of purchase
  notes         String?
  status        String      @default("pending") // "pending", "billed"
  billedDate    DateTime?   // When it was charged to bank
  bankTransactionId String? // Reference to the bank transaction when billed
  householdId   String?
  isShared      Boolean     @default(false)
  savingsGoalId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  creditCard    CreditCard  @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  category      Category?   @relation(fields: [categoryId], references: [id])
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  household     Household?  @relation(fields: [householdId], references: [id], onDelete: SetNull)
  savingsGoal   SavingsGoal? @relation(fields: [savingsGoalId], references: [id])

  @@index([creditCardId])
  @@index([userId])
  @@index([creditCardId, status])
  @@index([creditCardId, date])
  @@index([householdId])
  @@index([billedDate])
}
